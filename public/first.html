<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>Document</title>
    <script type="text/javascript" src="bower_components/angular/angular.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>

    <!--<script type="text/javascript" src="bower_components/jquery/dist/jquery.min.js"></script>-->
    <script type="text/javascript" src="bower_components/jquery-rateyo/min/jquery.rateyo.min.js"></script>
    <link href="bower_components/jquery-rateyo/min/jquery.rateyo.min.css" rel="stylesheet">
    <script type="text/javascript" src="bower_components/angular-rating-yo/src/angular-rating-yo.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.0/moment.min.js"></script>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <!--<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <!--<script defer src="https://use.fontawesome.com/releases/v5.0.9/js/all.js" integrity="sha384-8iPTk2s/jMVj81dnzb/iFR2sdA7u06vHJyyLlAd4snFpCl/SnyUjRrbdJsw1pGIl" crossorigin="anonymous"></script>-->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBn0GiQxOP7NmQNom0hY8YPlmDozSiopSE&libraries=places"></script>
    <script src="bower_components/angular-animate/angular-animate.js"></script>
    <script src="bower_components/angular-google-places-autocomplete/src/autocomplete.js"></script>
    <link rel="stylesheet" href="bower_components/angular-google-places-autocomplete/src/autocomplete.css">
    <style>
        #loader {
            display: none;

        }

        .nav-right {
            float: right;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(4, 25%);
            grid-column-gap: 10px;

            margin: 0;

        }



        html,
        body {
            height: 100%;

        }

        .has-error {
            border: 1px solid red;
        }

        .selected {
            background-color: yellow;
        }

        .unselected {
            background-color: white;
        }

        #placeDetailsMap {
            height: 500px;
            width: 100%;

        }

        #streetview {
            height: 500px;
            width: 100%;
        }

        #right-panel {
            height: 100%;
            width: 100%;
        }

        .favs {
            color: yellow;
        }

        .nofavs {
            opacity: 0.0;
        }

        @media (min-width: 576px) {

            .card-columns {
                column-count: 4;
            }
        } // Medium devices (tablets, 768px and up)
        @media (min-width: 768px) {
            .card-columns {
                column-count: 4;
            }
        } // Large devices (desktops, 992px and up)
        @media (min-width: 992px) {
            .card-columns {
                column-count: 4;
            }
        } // Extra large devices (large desktops, 1200px and up)
        @media (min-width: 1200px) {
            .card-columns {
                column-count: 4;
            }

        }

        #infoForm {
            padding-left: 30px;
            padding-right: 10px;
            padding-top: 15px;
            padding-bottom: 15px;
            margin-bottom: 10px;
        }
#keyname:after {
  content:"*";
  color:red;
}
        
        #fromlabel:after
        {
             content:"*";
            color:red;
        }

        
        /*    
        .placeResults.ng-hide-remove {
    transition: 1.5s linear opacity;
    opacity: 0;
}


.placeResults.ng-hide-remove-active {
    opacity: 1;
}
        .placeResults.ng-hide-add {
    transition: 1.5s linear opacity;
    opacity: 1;
}


.placeResults.ng-hide-add-active {
    opacity: 0;
}
        */

        /*    .placeResults {
 -webkit-transition:all cubic-bezier(0.250, 0.460, 0.450, 0.940) 2s;
    -moz-transition:all cubic-bezier(0.250, 0.460, 0.450, 0.940) 2s;
    -o-transition:all cubic-bezier(0.250, 0.460, 0.450, 0.940) 2s;
    transition:all cubic-bezier(0.250, 0.460, 0.450, 0.940) 2s;
  
  opacity:0;
  left: 0;
}

.placeResults.ng-hide {
  left: -100%;
  opacity:1;
  
}*/

        /*  .fade {
  transition: 1s linear all;
  -webkit-transition: 1s linear all;
}

.fade.ng-enter {
  opacity: 0;
}

        .fade.ng-enter.ng-enter-active {
  opacity: 1;
}

.fade.ng-leave {
  opacity: 1;
}

.fade.ng-leave.ng-leave-active {
  opacity: 0;
}
        */

        /*  .google-rev
        {
            opacity: 1;
            transition: 1s linear all;
        }
        
        .google-rev.ng-hide
        {
            opacity: 0;
            transition: 1s linear all;
        }
        */

        @keyframes slideOutLeft {
            to {
                transform: translateX(-100%);
            }
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
            }
            to {
                transform: translateX(0);
            }
        }

        @keyframes slideOutRight {
            /*from    { transform:translateX(-100%); }*/
            to {
                transform: translateX(100%);
            }
        }

        .pageResults.ng-leave {
            animation: slideInRight 0.5s both ease-in;
        }

        .pageResults.ng-hide {
            animation: slideOutLeft 0.5s both ease-in;
        }

        /*.placeResults.ng-leave        { animation:slideOutRight 0.5s both ease-in; }
  */

        .pageResults.ng-enter {
            animation: slideInRight 0.5s both ease-in;
        }
         .favoriteResults.ng-leave {
            animation: slideInRight 0.5s both ease-in;
        }

        .favoriteResults.ng-hide {
            animation: slideOutLeft 0.5s both ease-in;
        }

        /*.placeResults.ng-leave        { animation:slideOutRight 0.5s both ease-in; }
  */

        .favoriteResults.ng-enter {
            animation: slideInRight 0.5s both ease-in;
        }
        
        .placeResults.ng-leave
        {
            animation: slideInRight 0.5s both ease-in;
        }
        /*
.placeResults.ng-hide-add,
.placeResults.ng-hide-remove {
  display:block!important;
}

.placeResults.ng-hide-remove.ng-hide-remove-active {
  animation:1.5s slide-right;
        }

.placeResults.ng-hide-add.ng-hide-add-active {
  
  animation:1.5s slide-left;
}

.placeResults.ng-hide {
  right: 100%;
  display:block!important;
}
*/
      
        .yelp-rev {
            opacity: 1;
            transition: 1s linear all;
        }


        .yelp-rev.ng-hide {
            opacity: 0;
            transition: 1s linear all;
        }

        .yelp-rev.ng-leave {
            transition: 1s linear all;
            opacity: 1;
        }


        .yelp-rev.ng-leave-active {
            opacity: 0;
        }

        .yelp-rev.ng-enter {
            transition: 1s linear all;
            opacity: 0;
        }

    </style>
    <script>
        var favorites = [];
        var pageData = '';
        var lat = "0";
        var lon = "0";
        var table;
        var headers = ['#', 'Category', 'Name', 'Address', 'Favorite', 'Details'];

        var submitted = false;

        /*function tweetwindow()
             {

               //console.log('JavaScript window');
               windowOptions = 'scrollbars=yes,resizable=yes,toolbar=no,location=yes',
                width = 550,
                height = 420,
                winHeight = screen.height,
                winWidth = screen.width;

                left = Math.round((winWidth / 2) - (width / 2));
                top = 0;

                if (winHeight > height) {
                  top = Math.round((winHeight / 2) - (height / 2));
                }

              var tweetText = 'Check out NAME located	at ADDRESS.Website:URL #TravelAndEntertainmentSearch';
              var hashTags= '';
              var url= ''
              window.open("https://twitter.com/intent/tweet?text="+tweetText,'intent',windowOptions + ',width=' + width +
                                           ',height=' + height + ',left=' + left + ',top=' + top);


                return false;
             }
*/

    </script>
</head>

<body ng-app='myApp' ng-controller='myCtrl'>
    <div id="map"></div>



    <div class='container-fluid'>
        <div class='col-offset-6'>
            <div class='offset-lg-2 col-lg-8'>

                <form class="bg-light justify-content-center" id='infoForm' name='infoForm'>
                    <div class='form-group row'>
                        <h3 class="col-lg-10 text-center title">Travel and Entertainment Search</h3>
                    </div>
                    <div class="form-group row">
                        <label for="keyword" id="keyname" class='col-lg-2 control-label'>Keyword</label>
                        <div class='col-lg-offset-2 col-lg-8'>
                            <input type="text" id="keyword" name="keyword" ng-class="{'is-invalid' : infoForm.keyword.$invalid && infoForm.keyword.$touched }" ng-model="keyword" class="form-control" required>
                            <div class='invalid-feedback'>Please enter a keyword.</div>
                        </div>
                    </div>

                    <div class="form-group row">

                        <label for="category" class='col-lg-2'>Category</label>

                        <div class='col-lg-6'>
                            <select class="form-control col-lg-*" id="category" name="category" ng-model="category">
                    <option ng-repeat="x in formHeaders" value={{x}}>{{x}}</option>
                  </select>
                        </div>
                    </div>

                    <div class="form-group row">
                        <label for="distance" class='control-label col-lg-2'>Distance</label>
                        <div class='col-lg-offset-2 col-lg-6'>
                            <input type="number" id="distance" name="distance" class="form-control" placeholder="10">

                        </div>
                    </div>
                    <div class="form-group row">
                        <label class='control-label col-lg-2' id='fromlabel'>From</label>
                        <div class='col-lg-8 p-0' id='radioButton'>

                            <div class='form-check'>
                                <label for="options1"></label>
                                <input type="radio" name="options" id="options1" value="first" ng-model="radVal" checked> Current location

                            </div>

                            <div class='form-check mx-auto'>
                                <label for="options2"> </label>
                                <input type="radio" style="margin-left: 0;" name="options" id="options2" value="second" ng-model="radVal"> Others, Please specify: 
                                <input type="text" class="form-control ml-4" name='location' id='location' ng-model="location" ng-class="{ 'is-invalid' : infoForm.location.$invalid && infoForm.location.$touched }" placeholder='Enter a location' ng-disabled="radVal=='first'" required g-places-autocomplete ng-model="location" />
                                <!--                                <input type="text" name='location' class='form-control' id='location' ng-model="location" ng-class="{ 'is-invalid' : infoForm.location.$invalid && infoForm.location.$touched }" placeholder='Enter a location' disabled required>-->
                                <div class='invalid-feedback'>Please enter a location.</div>

                            </div>
                        </div>


                    </div>


                    <div class="form-group row">
                        <div class='col-lg-4'>
                            <button type="submit" ng-init="geolocation()" ng-click="getJSON()" id='search' name="search" class="btn btn-primary" ng-disabled="infoForm.keyword.$invalid ||
  (radVal=='second' && infoForm.location.$invalid)|| !geolocate"><i class="fa fa-search"></i>Search</button>
                            <button type="button" name="clear" ng-click="clearAll()" class='btn btn-light'>Clear</button>

                        </div>

                    </div>
                </form>
            </div>


            <div class='container'>
                <div class='container col-lg-4 col-offset-6 centered'>
                    <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" id="pills-results-tab" ng-click="placeDetails=false;showRes=true;" data-toggle="pill" href="#res" role="tab" aria-controls="res" aria-selected="true">Result</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="pills-favorites-tab" ng-click="placeDetails=false;showFav=true;" data-toggle="pill" href="#favs" role="tab" aria-controls="favs" aria-selected="false">Favorites</a>
                        </li>

                    </ul>
                </div>
                <div class="tab-content" id="nav-tabContent">
                    <div class='tab-pane fade show active' aria-labelledby="pills-results-tab" id="res">
                        <div class="container pageResults" ng-show="showRes">

                            <div class="float-right" ng-show="comp_results.length > 0">
                                <button ng-disabled="selectedIndex==-1" ng-click="showLatestDetails(true)">Details<i class="fa fa-chevron-right"></i></button>
                            </div>
                            <table class="table" ng-show="comp_results.length > 0">
                                <thead>
                                    <tr>
                                        <td ng-repeat="x in headers">{{x}}</td>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr ng-repeat="row in comp_results[page_index]" ng-class="{'alert alert-warning': $index==(selectedIndex-page_index*20)}">
                                        <td>{{$index+page_index*20+1}}</td>
                                        <td><img ng-src="{{row.icon}}" width="50px"></td>
                                        <td>{{row.name}}</td>
                                        <td>{{row.vicinity}}</td>
                                        <td><button ng-click="addfavorite(row.place_id,$index)" id="{{row.place_id}}">
                      <i class="fa fa-star" ng-class='{favs: checkFavorite(row.place_id)}'></i>
                    </button></td>
                                        <td ng-init="placeDetails=false"><button ng-click="getDetails(row,$index,true)"><i class="fa fa-chevron-right"></i></button></td>

                                    </tr>

                                </tbody>
                            </table>


                            <div class='text-center' ng-show="comp_results.length > 0">
                                <button id="prev" ng-show="page_index!=0" ng-click="getPreviousToken()">Previous</button>
                                <button id="next" ng-show="page_tokens[page_index]!== undefined" ng-click="getNextToken()">Next </button>
                            </div>
                            <div class="alert alert-warning" role="alert" ng-show="comp_results.length==0 && showRes && !api_failure">
                                No records found.
                            </div>
                            <div class="alert alert-danger" role="alert" ng-show="api_failure">
                              Failed to get search results.
                            </div>
                        </div>



                    </div>
                    <div class='tab-pane fade' aria-labelledby="pills-favorites-tab" id="favs">
                        <div class="container favoriteResults" ng-show="showFav">
                            <div class="float-right" ng-show="favorites.length > 0">
                                <button ng-disabled="favselectedIndex==-1" ng-click="showLatestDetails(false)">Details<i class="fa fa-chevron-right"></i></button>
                            </div>
                            <table class="table" ng-show="favorites.length > 0">
                                <thead>
                                    <tr>
                                        <td ng-repeat="x in headers">{{x}}</td>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr ng-repeat="row in favorites track by $index" ng-class="{'alert alert-warning': $index==favselectedIndex}">
                                        <td>{{$index+1}}</td>
                                        <td><img ng-src="{{row.icon}}" width="50px"></td>
                                        <td>{{row.name}}</td>
                                        <td>{{row.vicinity}}</td>
                                        <td><button ng-click="deletefav(row.place_id,$index)"><i class="fa fa-trash-o"></i></button></td>
                                        <td ng-init="placeDetails=false"><button ng-click="getDetails(row,$index,false)"><i class="fa fa-chevron-right" ></i></button></td>

                                    </tr>

                                </tbody>
                            </table>
                            <div class="alert alert-warning" role="alert" ng-show="favorites.length==0">
                                No records found.
                            </div>
                           

                        </div>

                    </div>


                </div>


            </div>

        </div>
        <div class="progress" id="mainbar" ng-show="isprogress== true">
            <div class="progress-bar progress-bar-striped progress-bar-animated" id="pbar" role="progressbar" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100" style="width: 50%;"></div>
        </div>
    </div>




    <div class="container placeResults" ng-show="placeDetails==true">

        <h2 class="text-center" ng-init="place_title=''">{{place_title}}</h2>


        <!-- Nav tabs -->
        <div class="row">

            <div class="col-12">

                <div class="float-left">
                    <button ng-click="goBack()"><i class="fa fa-chevron-left" ></i>List</button>
                </div>
                <div class="float-right">
                    <button id={{place_id}} ng-click="addFavoriteDets(place_id)">

                <i class="fa fa-star" ng-class='{favs: checkFavorite(place_id)}'></i>
                </button>

                    <button class='btn' ng-click="tweetwindow()">
                <img src="http://cs-server.usc.edu:45678/hw/hw8/images/Twitter.png" style="width: 30px">
            
                </button>
                </div>
            </div>
        </div>




        <div class="container">
            <ul class="nav nav-tabs justify-content-end">
                <li class="nav-item">
                    <a class="nav-link active" data-toggle="tab" href="#tab1">Info</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-toggle="tab" href="#tab2">Photos</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-toggle="tab" href="#tab3">Map</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-toggle="tab" href="#tab4">Reviews</a>
                </li>
            </ul>
        </div>

        <!-- Tab panes -->
        <div class="tab-content">
            <div id="tab1" class="container tab-pane active">
                <div class='container mt-2'>
                <table class='table table-striped'>
                    <tr>
                        <th>Address</th>
                        <td>{{place_det[0].formatted_address}}</td>
                    </tr>
                    <tr ng-show="place_det[0].international_phone_number!== undefined">
                        <th>Phone Number</th>
                        <td>{{place_det[0].international_phone_number}}</td>
                    </tr>
                    <tr ng-show="place_det[0].price_level!== undefined">
                        <th>Price Level</th>
                        <td>{{place_det[0].price_level}}</td>
                    </tr>
                    <tr ng-show="place_det[0].rating!== undefined">
                        <th>Rating</th>
                        <td><div><div style="float:left;">{{place_det[0].rating}}</div><div class="mt-1" style="float:left;"><rate-yo style="float:left;" on-set="set" ng-model="rating" read-only="options.readOnly" options="{ratedFill: '#f00', rating: place_det[0].rating, starWidth: '16px'}"></rate-yo></div></div></td>
                    </tr>
                    <tr ng-show="place_det[0].url !== undefined">
                        <th>Google Page</th>
                        <td><a target="_blank" href="{{place_det[0].url}}">{{place_det[0].url}}</a></td>
                    </tr>
                    <tr ng-show="place_det[0].website!== undefined">
                        <th>Website</th>
                        <td><a target="_blank" href="{{place_det[0].website}}">{{place_det[0].website}}</a></td>
                    </tr>
                    <tr>
                        <th>Hours</th>
                        <td ng-init="open_now= true">
                            
                            <div class='container' ng-show="open_now">Open now: {{current_timings}}<span style="margin-top: 0px;"><button type="button" class="btn btn-link" data-toggle="modal" data-target="#timings">Daily open hours</button></span></div>
                            <div class='container' ng-show="!open_now">Closed<span style="margin: 0px;"><button type="button" class="btn btn-link" data-toggle="modal" data-target="#timings">Daily open hours</button></span></div>
                            

                            <div class="modal fade" id="timings">
                                <div class="modal-dialog modal-dialog-centered">
                                    <div class="modal-content">

                                        <!-- Modal Header -->
                                        <div class="modal-header">
                                            <h4 class="modal-title">Open hours</h4>
                                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                                        </div>

                                        <!-- Modal body -->
                                        <div class="modal-body">
                                            <table class="table">

                                                <thead>
                                                    <tr>
                                                        <th>{{current_day_time.day}}</th>
                                                        <th>{{current_day_time.time}}</th>
                                                    </tr>

                                                </thead>
                                                <tbody ng-show="arr_day_time.length > 0">
                                                    <tr ng-repeat="timestamp in arr_day_time track by $index">
                                                        <td>{{timestamp.day}}</td>
                                                        <td>{{timestamp.time}}</td>
                                                    </tr>
                                                </tbody>

                                            </table>
                                        </div>

                                        <!-- Modal footer -->
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                </table>
                </div>

            </div>

            <div id="tab2" class="container tab-pane fade">
                <div class='container mt-2'>
                    <div class="card-columns" ng-show="photos.length > 0">
                    <div class="card" ng-repeat="url in photos track by $index">
                        <a href="{{url}}" target="_blank">
                           <img class="card-img-top" ng-src="{{url}}"></a>
                    </div>

                    </div>
                    <div class="alert alert-warning" role="alert" ng-show="photos.length==0">
                        No photos found.
                    </div>

                
                </div>
                
            </div>
            <div id="tab3" class="container tab-pane fade">
                <div class="container">
                    <form name="mapForm" novalidate>
                        <div class="form-row">

                            <div class="form-group col-md-4">

                                <label for="fromlocation" class="form-check-label">From</label>
                                <input type="text" class="form-control" id="fromlocation" ng-model='source' ng-focus="Autocomplete()" required>
                            </div>
                            <div class="form-group col-md-4">
                                <label for="destination" class="form-check-label">To</label>
                                <input type="text" class="form-control" id="destination" value="{{place_det[0].formatted_address}}" readonly>
                            </div>
                            <div class="form-group col-md-2">
                                <label for="travel_mode" class="form-check-label">Travel Mode</label>
                                <select class="form-control" id="travel_mode" name="travel_model">
                                <option value="DRIVING" selected>Driving</option>
                                <option value="BICYCLING">Bicycling</option>
                                <option value="TRANSIT">Transit</option>
                                <option value="WALKING">Walking</option>
                            </select>

                            </div>
                            <div class="form-group col-md-2">

                                <button type="submit" id='directions' ng-disabled="mapForm.source.$pristine" ng-click="getDirections()" name="directions" class="btn btn-primary mt-4">Get Directions</button>
                            </div>
                        </div>


                    </form>

                    <div class='row'>

                        <button type="button" class="btn" ng-show="showMap" ng-click="showMap=false"><img style="width:30px; height:30px;" class='button' ng-init="showMap=true" ng-src="http://cs-server.usc.edu:45678/hw/hw8/images/Pegman.png" ></button>

                        <button type="button" class="btn" ng-show="!showMap" ng-click="showMap=true"><img style="width:30px; height:30px;" class='button' ng-src="http://cs-server.usc.edu:45678/hw/hw8/images/Map.png" ></button>

                    </div>

                </div>



                <div class='container' ng-show="showMap==true">
                    <div id="placeDetailsMap"></div>
                    <div id="right-panel"></div>
                </div>
                <div class='container' ng-show="showMap==false">
                    <div id="streetview">
                    </div>

                </div>
            </div>

            <div id="tab4" class="container tab-pane fade">

                <div class="container p-2">

                    <div class="row">
                        <div class="col-lg-3 mb-2">

                            <div class='dropdown'>
                                <button class="btn btn-secondary dropdown-toggle" ng-model="reviewType" ng-init="reviewType= 'Google Reviews'" type="button" id="dropdownMenu2" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              {{reviewType}}
          </button>
                                <div class="dropdown-menu" aria-labelledby="dropdownMenu2" id="googyelp">
                                    <button class="dropdown-item" type="button" ng-click="isgoogle= true; reviewType='Google Reviews'">Google Reviews</button>
                                    <button class="dropdown-item" type="button" ng-click="isgoogle= false; reviewType='Yelp Reviews'">Yelp Reviews</button>
                                </div>
                            </div>


                        </div>

                        <div class="col-lg-3">

                            <div class='dropdown'>
                                <button class="btn btn-secondary dropdown-toggle" ng-model="sortingType" ng-init="sortingType= 'Default Order'" type="button" id="dropdownMenu2" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              {{sortingType}}
          </button>
                                <div class="dropdown-menu" aria-labelledby="dropdownMenu2">
                                    <button class="dropdown-item" type="button" ng-click="orderReviews(1); sortingType= 'Default Order'">Default Order</button>
                                    <button class="dropdown-item" type="button" ng-click="orderReviews(2); sortingType= 'Highest Rating'">Highest Rating</button>
                                    <button class="dropdown-item" type="button" ng-click="orderReviews(3); sortingType= 'Lowest Rating'">Lowest Rating</button>
                                    <button class="dropdown-item" type="button" ng-click="orderReviews(4); sortingType='Most Recent'">Most Recent</button>
                                    <button class="dropdown-item" type="button" ng-click="orderReviews(5); sortingType='Least Recent'">Least Recent</button>

                                </div>
                            </div>

                        </div>

                    </div>




                </div>


                
                <div class='container' ng-init="isgoogle == true">


                    <div class='container google-rev' ng-show="isgoogle">
                        <div class='row border mb-2' ng-repeat="review in google_reviews | orderBy: sortingOrder" ng-show="isgoogle && google_reviews.length!=0">
                            <div class='col-2 justify-content-center'>
                                <a target='_blank' href="{{review.author_url}}"><img style="margin: auto;"ng-src="{{review.profile_photo_url}}" width="50px"></a>
                            </div>
                            <div class='col-10'>
                                <div><a target='_blank' href="{{review.author_url}}">{{review.author_name}}</a></div>
                                <span class="mt-1" style="float:left;"><rate-yo on-set="set" ng-model="rating" read-only="options.readOnly" options="{ratedFill: '#f00', rating: review.rating, starWidth: '15px'}"></rate-yo> </span> <span style="float:left;">{{review.time}}</span><br/>
                                <div ng-if="review.text.length > 0">
                                    {{review.text}}
                                </div>
                            </div>
                        </div>
                        <div class="alert alert-warning" role="alert" ng-show="google_reviews.length==0 || google_reviews===null">
                            No records found.
                        </div>
                    </div>


                    <div id="yelp" class='container yelp-rev' ng-show="!isgoogle">

                        <div class='row border mb-2' ng-repeat="review in yelp_reviews | orderBy: yelpsortingOrder" ng-show="!isgoogle && yelp_reviews.length!=0">
                            <div class='col-2 justify-content-center'>
                                <a href="{{review.url}}"><img ng-src="{{review.user.image_url}}" width="50px"></a>
                            </div>
                            <div class='col-10'>
                                <div><a target='_blank' href="{{review.url}}">{{review.user.name}}</a></div>
                                <span class="mt-1" style="float:left;"><rate-yo on-set="set" ng-model="rating" read-only="options.readOnly" options="{ratedFill: '#f00', rating: review.rating, starWidth: '15px'}"></rate-yo> </span> <span style="float:left;">{{review.time_created}}</span><br/>
                                <div ng-if="review.text.length > 0">
                                    {{review.text}}
                                </div>
                            </div>
                        </div>
                        <div class="alert alert-warning" role="alert" ng-show="yelp_reviews.length==0 || yelp_reviews===null">
                            No records found.
                        </div>


                    </div>

                </div>

            </div>
        </div>
    </div>






    <script>
        //Example starter JavaScript for disabling form submissions if there are invalid fields

        var app = angular.module('myApp', ['rateYo', 'google.places', 'ngAnimate']);
        // angular.module('myApp').requires.push('vsGoogleAutocomplete');
        //  var myAppModule = angular.module('myApp', ['rateYo']);
        app.controller('myCtrl', function($scope, $http) {
            //console.log('yes');
            $scope.favorites = [];
            console.log($scope.favorites);
            $scope.submitted = false;
            $scope.sortingOrder = null;
            $scope.place_det = [];
            $scope.headers = ["#", "Category", "Name", "Address", "Favorite", "Details"];
            $scope.results = [];
            $scope.photos = [];
            $scope.google_reviews = [];
            $scope.yelp_reviews = [];
            $scope.yelpsortingOrder = null;
            $scope.isgoogle = true;
            $scope.place_id = 'null';
            $scope.current_timings = '';
            $scope.open_now = true;
            $scope.daily_timings = [];
            $scope.arr_day_time = [];
            $scope.current_day = moment.utc().utcOffset(-420).day();
            $scope.page_index = 0;
            $scope.page_tokens = [];
            $scope.comp_results = [];
            $scope.isnext = false;
            $scope.radVal = 'first';
            $scope.api_failure = false;
            $scope.source = 'Your location';
            $scope.showRes = false;
            $scope.showFav = false;
            $scope.placeDetails = false;

            $scope.favClick = false;
            $scope.resClick = false;

            $scope.selectedIndex = -1;
            $scope.favselectedIndex = -1;


            $scope.geolocate = false;
            $scope.showMap = true;

            $scope.isprogress = false;
            $scope.current_day_time = [];
            $scope.directions_display = '';
            $scope.directions_service = '';
            $scope.formHeaders = ['Default', 'Airport', 'Amusement Park', 'Aquarium', 'Art Gallery', 'Bakery', 'Bar', 'Beauty Salon', 'Bowling Alley', 'Bus Station', 'Cafe', 'Campground', 'Car rental', 'Casino', 'Lodging', 'Movie Theater', 'Museum', 'Night Club', 'Park', 'Parking', 'Restaurant', 'Shopping Mall', 'Stadium', 'Subway Station', 'Taxi Stand', 'Transit Station', 'Travel Agency', 'Zoo'];
            $scope.place_lat = 0;
            $scope.place_lon = 0;
            $scope.category = 'Default';
            $scope.showMap = true;

            $scope.set = function() {
                console.log($scope.isgoogle);
            }

            $scope.goBack = function() {
                console.log($scope.resClick);
                if ($scope.resClick) {
                    $scope.placeDetails = false;
                    $scope.showRes = true;
                } else {
                    $scope.placeDetails = false;
                    $scope.showFav = true;
                }
                //window.history.back();
            }
            $scope.getOldFavs = function() {
                //console.log('Got me some old favs');
                //console.log(localStorage);
                console.log(localStorage);
                $scope.favorites = [];
                for (var i = 0; i < localStorage.length; ++i) {
                    var key = localStorage.key(i);
                    $scope.favorites.push(JSON.parse(localStorage.getItem(key)));
                }
                //console.log($scope.favorites);
            }

            $scope.clearAll = function() {
                var key = document.getElementById('keyword');
                key.value = '';
                document.getElementById('distance').innerHTML = '';
                if ($scope.radVal == 'second') {
                    document.getElementById('location').value = '';
                    $scope.radVal = 'first';
                }
                //document.getElementById('category').value='Default';
                $scope.category = 'Default';
                $scope.showRes = false;
                $scope.showFav = false;
                $scope.placeDetails = false;
            }

            $scope.getOldFavs();
            $scope.getJSON = function() {
                var formData = {};
                $scope.placeDetails = false;
                //$scope.showRes= true;
                $scope.showFav = false;
                $scope.page_index = 0;
                $scope.page_tokens = [];
                $scope.comp_results = [];
                //console.log($scope.favorites);
                //$('#mainbar').css('display','block');
                $scope.isprogress = true;
                $scope.selectedIndex = -1;
                $scope.favselectedIndex = -1;
                //$('#pbar').css('display','block');
                formData.keyword = $('#keyword').val();
                console.log(formData.keyword);
                formData.category = $scope.category.toLowerCase().replace(" ", "_");
                formData.distance = $('#distance').val();
                console.log(formData.distance);
                console.log(formData.category);
                if (formData.distance == '') {
                    formData.distance = 10;
                }
                //console.log(formData.distance);
                var radVal = $('input[type=radio][name=options]:checked').val();
                //console.log(radVal);
                //console.log($scope.location);


                var isError = false;
                $scope.comp_results = [];

                if (radVal == 'second') {

                    if ($scope.location.formatted_address !== undefined) {
                        console.log($scope.location.geometry.location.lat());
                        console.log($scope.location.geometry.location.lng());
                        //console.log($scope.location.formatted_address);
                        formData.lat = $scope.location.geometry.location.lat();
                        formData.lon = $scope.location.geometry.location.lng();
                        formData.place = $scope.location.formatted_address;
                    } else {
                        formData.place = $('#location').val();

                    }
                    //formData.place = $('#location').val();
                    //console.log(formData.place);


                } else {

                    formData.lat = $scope.lat;
                    formData.lon = $scope.lon;
                    //console.log(formData);
                }

                console.log('Reached nearbysearch');

                $http.get('/geocoding', {
                    params: {
                        keyword: formData.keyword,
                        category: formData.category,
                        distance: formData.distance,
                        place: formData.place,
                        lat: formData.lat,
                        lon: formData.lon
                    }
                }).then(function(response) {
                    if (response.data.status != undefined)
                        //console.log('Success');
                        console.log(response.data);

                    //console.log(submitted);
                    if (response.data.status == 'OK') {
                        $scope.submitted = true;
                        $scope.results = response.data.results;
                        $('#pbar').css('display', 'none');
                        $('#mainbar').css('display', 'none');
                        $scope.comp_results.push(response.data.results);
                        console.log(response.data);
                        if (response.data.next_page_token) {
                            console.log('Next token present mate');
                            $scope.isnext = true;
                            $scope.page_tokens.push(response.data.next_page_token);

                        }
                        $scope.showRes = true;
                    }


                }, function(response) {
                    $scope.api_failure = true;
                    $scope.showRes = true;
                
                    console.log('fail');
                    return;

                });





            }


            $scope.tweetwindow = function() {

                //console.log('JavaScript window');
                windowOptions = 'scrollbars=yes,resizable=yes,toolbar=no,location=yes',
                    width = 550,
                    height = 420,
                    winHeight = screen.height,
                    winWidth = screen.width;
                console.log($scope.place_det[0]);
                left = Math.round((winWidth / 2) - (width / 2));
                top = 0;

                if (winHeight > height) {
                    top = Math.round((winHeight / 2) - (height / 2));
                }

                var tweetText = 'Check out ' + encodeURI($scope.place_det[0].name) + ' located at ' + encodeURI($scope.place_det[0].formatted_address) + ' Website: ';
                var hashTags = ['TravelAndEntertainmentSearch'];
                var url =  encodeURI($scope.place_det[0].website);
                window.open("https://twitter.com/intent/tweet?text=" + tweetText + '&url=' + url+ '&hashtags=' + hashTags, 'intent', windowOptions + ',width=' + width +
                    ',height=' + height + ',left=' + left + ',top=' + top);


                //return false;

            }
            $scope.check = function() {
                console.log($scope.place_id);
            }


            $scope.addFavoriteDets = function(place_id) {
                if (localStorage.getItem(place_id) === null) {
                    //console.log($scope.place_det[0]);
                    localStorage.setItem(place_id, JSON.stringify($scope.place_det[0]));
                    $scope.favorites.push($scope.place_det[0]);
                }
                else
                    {
                        localStorage.removeItem(place_id);
                        $scope.getOldFavs();
                    }
            }
            $scope.addfavorite = function(fav_id, ind) {

                //console.log(ind);
                //console.log(fav_id);
                /* $('#' + fav_id + ' i').css({
                     "color": "yellow"
                 }).removeClass('fa-star-o').addClass('fa-star');*/
                //console.log($scope.results[ind].place_id);

                if (localStorage.getItem(fav_id) === null) {
                    localStorage.setItem(fav_id, JSON.stringify($scope.results[ind]));
                    $scope.favorites.push($scope.results[ind]);
                }
                
                else
                    {
                        localStorage.removeItem(fav_id);
                        $scope.getOldFavs();
                    }

                //console.log('Retrieval: ')
                //console.log(localStorage.getItem(fav_id));
                //var $this = ($this);
                //console.log(place);
                //console.log($(this).attr('id'));

                //$(this).css({"color": "yellow"}).removeClass('fa-star-o').addClass('fa-star');
            }

            $scope.deletefav = function(fav_id, ind) {
                $scope.favorites.splice(ind, 1);
                localStorage.removeItem(fav_id);

            }


            $scope.orderReviews = function(type) {
                console.log(type);
                if (type == 1) {

                    $scope.yelpsortingOrder = null;
                    $scope.sortingOrder = null;
                } else if (type == 2) {

                    $scope.yelpsortingOrder = '-rating';

                    $scope.sortingOrder = '-rating';




                } else if (type == 3) {

                    $scope.yelpsortingOrder = 'rating';


                    $scope.sortingOrder = 'rating';


                } else if (type == 4) {

                    $scope.yelpsortingOrder = '-time_created';

                    $scope.sortingOrder = '-time';



                } else {

                    $scope.yelpsortingOrder = 'time_created';

                    $scope.sortingOrder = 'time';


                }



            }

            $scope.getNextToken = function() {
                //console.log($scope.page_index);
                //console.log($scope.page_tokens);
                //$scope.comp_results.push()

                if ($scope.comp_results[$scope.page_index + 1] !== undefined) {
                    $scope.page_index += 1;

                } else {

                    $http.get('/nextPageSearch', {
                        params: {
                            pagetoken: $scope.page_tokens[$scope.page_index]
                        }
                    }).then(function(response) {
                        //console.log(response.id)
                        //let yelpJson = JSON.parse(resp)
                        console.log(response.data.status);
                        if (response.data.status == 'OK') {
                            //console.log(response.data);
                            $scope.page_index += 1;
                            $scope.comp_results.push(response.data.results);
                            console.log('Comprehensive list: ');
                            console.log($scope.comp_results);
                            if (response.data.next_page_token) {
                                $scope.page_tokens.push(response.data.next_page_token);
                                $scope.isnext = true;
                            }
                            //console.log($scope.page_tokens);

                        } else {
                            console.log('No records found');
                        }

                    }, function(response) {

                        console.log('fail');

                    });


                }


            }

            $scope.checkFavorite = function(placeID) {
                //console.log(placeID);
                if (localStorage.getItem(placeID) !== null) {


                    return true;
                } else {
                    /*console.log('No');
                      $('i .fa .fa-star').css({
                        }).removeClass('fa-star-o').addClass('fa-star');*/
                    return false;
                }

            }


            $scope.getPreviousToken = function() {
                $scope.page_index -= 1;
            }

            var panorama;
            $scope.panorama = function() {


                //google.maps.event.trigger(document.getElementById('streetview'), 'resize');
                var myLatLng = {
                    lat: $scope.place_lat,
                    lng: $scope.place_lon
                };
                var map = new google.maps.Map(document.getElementById('streetview'), {
                    center: myLatLng,
                    zoom: 18,
                    streetViewControl: false
                });
                //var toggle = panorama.getVisible();
                panorama = map.getStreetView();
                panorama.setPosition(astorPlace);
                panorama.setPov( /** @type {google.maps.StreetViewPov} */ ({
                    heading: 265,
                    pitch: 0
                }));
                panorama.setVisible(true);

            }
            $scope.getDirections = function() {

                console.log('Got directions')
                var map = new google.maps.Map(document.getElementById('placeDetailsMap'), {
                    center: {
                        lat: -33.866,
                        lng: 151.196
                    },
                    zoom: 15
                });

                var directionsService = new google.maps.DirectionsService;
                var directionsDisplay = new google.maps.DirectionsRenderer({
                    draggable: true,
                    map: map,
                    panel: document.getElementById('right-panel')
                });
                //var map2= document.getElementById('placeDetailsMap');
                var start = document.getElementById('fromlocation').value;
                var end = document.getElementById('destination').value;

                var temp = start.toLowerCase();

                if (temp === 'my location' || temp === '' || temp === 'your location') {
                    console.log('It is my location');
                    console.log($scope.lat);
                    console.log($scope.lon);
                    start = new google.maps.LatLng($scope.lat, $scope.lon);
                }

                travel_mode = document.getElementById('travel_mode').value;
                console.log(travel_mode);
                directionsService.route({
                    origin: start,
                    destination: end,
                    provideRouteAlternatives: true,
                    travelMode: travel_mode
                }, function(response, status) {
                    if (status === 'OK') {
                        directionsDisplay.setDirections(response);
                        console.log(response);
                    } else {
                        window.alert('Directions request failed due to ' + status);
                    }
                });

                directionsDisplay.setMap(map);
                //document.getElementById('fromlocation').addEventListener('change', onChangeHandler);
            }


            $scope.Autocomplete = function() {
                console.log('called');
                var autocomplete1 = new google.maps.places.Autocomplete(document.getElementById('fromlocation'));
                var autocomplete2 = new google.maps.places.Autocomplete(document.getElementById('location'));
                //autocomplete.addListener('place_changed', fillValue);
            }


            $scope.loadMap = function() {
                console.log('Div with supposed map initialized');
            }

            $scope.geolocation = function() {
                $http.get("http://ip-api.com/json")
                    .then(function(response) {
                        //First function handles success
                        var jsonData = response.data;
                        console.log(jsonData);
                        $scope.lat = response.data.lat;
                        $scope.lon = response.data.lon;
                        console.log($scope.lat);
                        console.log($scope.lon);
                        $scope.geolocate = true;
                        console.log($scope.geolocate);
                    }, function(response) {
                        //Second function handles error
                        //$scope.content = "Something went wrong";
                        console.log('Error');
                    });

            }
            
            $scope.showLatestDetails= function(isRes)
            {
                $scope.showRes= false;
                $scope.showFav = false;
                $scope.placeDetails= true;
                if(isRes)
                    {
                        $scope.resClick = true;
                        $scope.favClick = false;
                    }
                else
                    {
                        $scope.resClick = false;
                        $scope.favClick = true;
                    }
                
            }

            $scope.getDetails = function(row, ind, isRes) {

                //console.log(isRes);
                $scope.showRes = false;
                $scope.showFav = false;
                if (isRes) {
                    $scope.resClick = true;
                    $scope.favClick = false;
                    console.log('Results button clicked');
                    $scope.selectedIndex = ind+$scope.page_index*20;
                    if ($scope.place_det.length != 0) {
                        if ($scope.place_det[0] == row)
                            return;
                    }

                } else {
                    $scope.resClick = false;
                    $scope.favClick = true;
                    console.log('Favorite button clicked');
                    $scope.favselectedIndex = ind;

                    if ($scope.place_det.length != 0) {
                        if ($scope.place_det[0] == row)
                            return;
                    }


                }
                //$scope.selectedIndex =ind;

                console.log('Row object:');
                console.log(row);
                $scope.placeDetails = true;
                // $scope.unselectedIndex= $scope.selectedIndex;
                $scope.place_lat = row.geometry.location.lat;
                $scope.place_lon = row.geometry.location.lng;
                //console.log($scope.place_lat);
                //console.log($scope.place_lon);
                placeid = row.place_id;

                //console.log('Unselected Indx: '+$scope.unselectedIndex);
                var myLatLng = {
                    lat: $scope.place_lat,
                    lng: $scope.place_lon
                };
                var map = new google.maps.Map(document.getElementById('map'), {
                    center: {
                        lat: -33.866,
                        lng: 151.196
                    },
                    zoom: 15
                });

                var map1 = new google.maps.Map(document.getElementById('placeDetailsMap'), {
                    center: myLatLng,
                    zoom: 10

                });

                var marker = new google.maps.Marker({
                    position: myLatLng,
                    map: map1,
                    title: 'Hello World!'
                });

                var map2 = new google.maps.Map(document.getElementById('streetview'), {
                    center: myLatLng,
                    zoom: 10

                });
                panorama = map2.getStreetView();
                panorama.setPosition(myLatLng);
                panorama.setPov( /** @type {google.maps.StreetViewPov} */ ({
                    heading: 265,
                    pitch: 0
                }));
                panorama.setVisible(true);
                //google.maps.event.trigger(document.getElementById('streetview'), 'resize');
                var service = new google.maps.places.PlacesService(map);

                service.getDetails({
                    placeId: placeid
                }, function(place, status) {
                    if (status === google.maps.places.PlacesServiceStatus.OK) {
                        console.log(place);
                        $scope.place_det[0] = place;
                        $scope.place_title = place.name;
                        console.log($scope.place_det[0]);
                        $scope.place_id = place.place_id;
                        
                        if(place.price_level && place.price_level!= "")
                            {
                                 $scope.place_det[0].price_level = '$'.repeat(place.price_level);
                            }
                       
                        //console.log(place.address_components);
                        //console.log(place.opening_hours.open_now);

                        var utc_day = moment.utc().utcOffset(place.utc_offset).day();
                        console.log(utc_day);
                        if(place.opening_hours)
                            {
                                if (place.opening_hours.open_now == true) {

                                    $scope.current_timings = place.opening_hours.weekday_text[utc_day];
                                    var ind = $scope.current_timings.indexOf(":");
                                    $scope.current_timings = $scope.current_timings.slice(ind + 1);
                                    //console.log($scope.current_timings);
                                    $scope.open_now = true;

                                } else {
                                    $scope.open_now = false;
                                }
                            }
                        

                        if(place.opening_hours)
                            {
                                var timings = place.opening_hours.weekday_text.splice(utc_day - 1).concat(place.opening_hours.weekday_text.splice(0, utc_day - 1));

                                $scope.daily_timings = timings;

                                $scope.arr_day_time = []
                                var isFirstRow = false;
                                for (var index = 0; index < timings.length; ++index) {

                                    var day_time = {}
                                    day_time.day = timings[index].split('y:')[0] + 'y';
                                    day_time.time = timings[index].split('y:')[1];
                                    if (!isFirstRow) {
                                        $scope.current_day_time = day_time;
                                        isFirstRow = true;
                                    } else {
                                        $scope.arr_day_time.push(day_time);
                                    }



                                }

                                
                            }
                        
                        console.log($scope.arr_day_time);
                        var country = '';
                        var state = '';
                        var city = '';


                        console.log(place.address_components);
                        for (var index = 0; index < place.address_components.length; ++index) {
                            for (var j = 0; j < place.address_components[index].types.length; ++j) {
                                if (place.address_components[index].types[j] == 'country') {
                                    country = place.address_components[index].short_name;

                                } else if (place.address_components[index].types[j] == 'administrative_area_level_1') {
                                    state = place.address_components[index].short_name;
                                } else if (place.address_components[index].types[j] == 'locality') {
                                    city = place.address_components[index].short_name;
                                }
                            }
                        }


                        var formData = {};
                        formData.country = country;
                        formData.state = state;
                        formData.address = place.vicinity;
                        formData.city = city;
                        formData.name = place.name;
                        //console.log(formData);
                        $http.get('/yelpSearch', {
                            params: {
                                country: formData.country,
                                state: formData.state,
                                address: place.vicinity,
                                city: formData.city,
                                name: formData.name
                            }
                        }).then(function(response) {
                            //console.log(response.id)
                            //let yelpJson = JSON.parse(resp)
                            console.log(response.data);
                            if (response.data.length >= 1) {
                                var revData = {};
                                revData.id = response.data.id;
                                $scope.yelp_reviews = response.data;


                            } else {
                                console.log('No records found');
                            }

                        }, function(response) {

                            console.log('fail');

                        });
                        console.log('Photos');
                        if (place.photos) {
                            console.log(place.photos);
                            for (var index = 0; index < place.photos.length; ++index) {
                                $scope.photos.push(place.photos[index].getUrl({
                                    'maxWidth': 500,
                                    'maxHeight': 500
                                }));
                            }

                        }

                        if (place.reviews) {
                            $scope.google_reviews = place.reviews;

                            for (var index = 0; index < place.reviews.length; ++index) {

                                var val = "#rateYo" + index;
                                var b = document.getElementById(val);


                            }


                            for (var index = 0; index < place.reviews.length; ++index) {
                                $scope.google_reviews[index].time = moment.unix(place.reviews[index].time).format("YYYY-MM-DD HH:mm:ss");
                            }

                            //console.log('Google reviews object')

                        }

                        $scope.$apply();

                    }
                });
            }

        });

    </script>

    <script type="text/javascript" async src="https://platform.twitter.com/widgets.js"></script>
</body>

</html>
